# GitHub Copilot Instructions for Photonic CLI

## CLI Architecture

**Framework**: Cobra CLI with flags (github.com/spf13/cobra)

**Key Files**:
- `/internal/cli/cobra.go` - All Cobra command definitions 
- `/internal/pipeline/router.go` - Job processing and parameter extraction

## Available Commands

```
photonic [command]

Available Commands:
  agent       Start a Photonic agent for distributed photo management
  align       Align images for stacking or correction
  completion  Generate the autocompletion script for the specified shell
  config      Manage configuration settings
  help        Help about any command
  panoramic   Create panoramic images from multiple photos
  raw         Process RAW images using various tools
  serve       Start HTTP server with photo monitoring
  server      Start the complete Photonic gRPC server and web dashboard
  stack       Focus stack or noise reduction stack multiple images
  timelapse   Create timelapse videos from image sequences
  version     Show version information
  web         Start the Photonic web dashboard

Additional help topics:
  photonic scan       Scan directory for photos (placeholder)
```

### Command Examples
```bash
# Align images
./photonic align test-data/align/sample-3 --type astro --output output/aligned-test --star-threshold 0.85

# Stack images  
./photonic stack /photos/astro/ --method average --alignment star --output stacked.tif

# Process RAW
./photonic raw photo.cr2 --tool darktable --preset auto --output processed.jpg

# Create timelapse
./photonic timelapse /photos/sequence/ --fps 30 --stabilize --output timelapse.mp4

# Create panoramic
./photonic panoramic /photos/pano/ --projection cylindrical --output panoramic.tif
```

## Adding CLI Parameters

1. **Add flag to Cobra command in `cobra.go`**:
   ```go
   cmd.Flags().Float64Var(&variable, "flag-name", defaultValue, "description")
   ```

2. **Add to job options in Cobra command RunE function**:
   ```go
   Options: map[string]any{
       "flagName": variable, // use camelCase in options
   }
   ```

3. **Extract in router.go handleAlign/handleStack/etc**:
   ```go
   flagValue, _ := job.Options["flagName"].(float64)
   if flagValue <= 0 {
       flagValue = defaultValue
   }
   ```

4. **Pass to processor via Config field**:
   ```go
   config := map[string]any{
       "flagName": flagValue,
   }
   req := AlignmentRequest{..., Config: config}
   ```

5. **Extract in processor Align function**:
   ```go
   if req.Config != nil {
       if config, ok := req.Config.(map[string]any); ok {
           if value, ok := config["flagName"].(float64); ok && value > 0 {
               flagValue = value
           }
       }
   }
   ```

## Important Notes

- **DO NOT** modify `/internal/cli/cli.go` (old manual flag parsing)
- Use **Cobra flags** in `/internal/cli/cobra.go` 
- Job options use **camelCase** (e.g. "starThreshold" not "star-threshold")
- Always provide **default values** and **validation**
- Avoid **duplicate flag definitions** (check existing flags first)